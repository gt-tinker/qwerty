name: Run Tests
on:
  workflow_dispatch:
  push:
    paths:
      - dev/**
      - qir_runner
      - qwerty_ast/**
      - qwerty_melior
      - qwerty_mlir/**
      - qwerty_mlir_sys
      - qwerty_pyrt/**
      - qwerty_util/**
      - tweedledum
      - .github/**
jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout the repo
        uses: actions/checkout@v5
        with: 
          submodules: true
      - name: Install build dependencies
        run: sudo apt install -y ninja-build python3-dev libffi-dev libzstd-dev libtinfo-dev
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install python dependencies
        run: python -m pip install --upgrade pip setuptools
      - name: Setting up LLVM and MLIR
        run: |
          wget https://github.com/gt-tinker/qwerty-llvm-builds/releases/download/v20.1.7/llvm_mlir_rel_v20_1_7_x86_linux.tar.xz
          tar -xJvf llvm_mlir_rel_v20_1_7_x86_linux.tar.xz
          echo "$GITHUB_WORKSPACE/llvm20/bin" >> $GITHUB_PATH
      - name: Run the tests in virtual environment
        run: |
          export MLIR_DIR="$GITHUB_WORKSPACE/llvm20/lib/cmake/mlir"
          export QWERTY_BUILD_TESTS=true
          python3 -m venv venv
          . venv/bin/activate
          cd qwerty_pyrt
          pip install maturin
          maturin build --release --out dist
          pip install dist/*.whl
          ../dev/run-tests.sh
