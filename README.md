# The Compiler for Qwerty, a Basis-Oriented Quantum Programming Language

This is the compiler (and examples) for Qwerty, a quantum programming language
embedded in Python.

Documentation
-------------

The `docs/` directory contains more documentation that doesn't fit in this
README:

* [`docs/project-structure.md`](docs/project-structure.md): An overview of the
  contents of this project (i.e., which files do what) and how the sections in
  the paper submission map to source files.
* [`docs/examples.md`](docs/examples.md): A list of the example programs found
  in the `examples/` directory.
* [`docs/testing.md`](docs/testing.md): Details on our multi-faceted testing
  framework.
* [`docs/debugging.md`](docs/debugging.md): Guide for debugging the
  Qwerty compiler when it misbehaves.
* [`docs/eval.md`](docs/eval.md): Guide for running the evaluation for the
  CGO '25 paper on the Qwerty compiler.
* [`docs/qiree.md`](docs/qiree.md): Directions for building a copy of the
  Qwerty compiler/runtime that integrates with [QIR-EE][49], an execution
  engine for QIR.
* [`docs/artifact-README.md`](docs/artifact-README.md): This is the same README
  attached to the Zenodo artifact.

The rest of this README is dedicated to installation, basic testing, and
troubleshooting.

Building the Compiler
---------------------

### Step 1: Setting Up LLVM

[LLVM][25] is a heavy-duty compiler framework we use, along with its
sub-project [MLIR][26], in the Qwerty compiler. If you want to build the Qwerty
compiler, you have two options: (1) download pre-built LLVM libraries or (2)
build LLVM yourself. We discuss both options below.

#### Option 1: Use a Pre-Built LLVM Tarball

The artifact includes a tarball `llvm_mlir_rel_v19_1_2_x86_linux.tar.xz` that
is a Linux x86\_64 `-O2` build with assertions (~3GB uncompressed, ~500MB
compressed). You can extract it with something like:

    $ export LLVM_INSTALL_DIR=~/bin/llvm19
    $ mkdir -p "$LLVM_INSTALL_DIR"
    $ tar -C "$(dirname "$LLVM_INSTALL_DIR")" -xJvf ~/Downloads/llvm_mlir_rel_v19_1_2_x86_linux.tar.xz
    $ export PATH=$PATH:$LLVM_INSTALL_DIR/bin/
    $ export MLIR_DIR=$LLVM_INSTALL_DIR/lib/cmake/mlir/

All three `export`s above should probably be in [your `~/.bashrc`][24] (or your
`~/.zshrc` if you use zsh, e.g., if you are a macOS user).

#### Option 2: Build LLVM Yourself

See [`docs/build-llvm.md`](docs/build-llvm.md).

### Step 2: Building the Rest of the Qwerty Compiler

#### macOS/Linux

To test that LLVM was installed right in the last section, make sure the
following commands produce the expected output:

    $ mlir-opt --version
    LLVM (http://llvm.org/):
      LLVM version 19.1.2
      Optimized build with assertions.
    $ llvm-config --version
    19.1.2

Next, you need to install [Rust][8] (for [`qir-runner`][10]),
[`python3-venv`][45] (to make a **v**irtual **env**ironment),
[`python3-dev`][9] (Python C API headers for the Python C extension), and
[`libffi-dev`][28] and [`libxml2-dev`][39] (apparently required by
`qir-runner`, possibly transitively), [`libzstd-dev`][33], and
[`libtinfo-dev`][34] (both LLVM dependencies).

Finally, to build, run (the first command is a one-time thing):

    $ python3 -m venv venv
    $ . venv/bin/activate
    $ pip install -v .

_(Warning: the CMakeCache generated by [skbuild][48] might cause bizarre build
errors under unusual circumstances (such as upgrading LLVM), so try deleting
`_skbuild/` if you are seeing weird build issues.)_

Now, to test everything is working, try running one of the examples:

    $ python3 examples/dj.py
    Constant test:
    Classical: constant
    Quantum: constant

    Balanced test:
    Classical: balanced
    Quantum: balanced

For a more comprehensive test, you can run the following if you built with the
environment variable `QWERTY_BUILD_TESTS=true` (e.g., if you ran
`QWERTY_BUILD_TESTS=true pip install -v .`):

    $ test/run-tests.sh
    [...voluminous output...]
    100% tests passed, 0 tests failed out of 1

    [...voluminous output...]
    Ran 41 tests in 10.390s

    OK

#### Windows

This is nearly identical to the Unix instructions above except:
1. **You need to run all the commands in the "x64 Native Tools Command Prompt
   for VS 2022"**. (Try typing "x64" into the Start menu.) Otherwise, it will
   attempt a 32-bit build, causing x64 intrinsics not to show up and triggering
   many, many linker errors.
2. You need to tell CMake to use ninja. In `cmd`, this is
   `set CMAKE_GENERATOR=Ninja`. This is because msbuild does not seem to play
   along with Tweedledum.
3. Any forward slash `/` should be a backslash `\` instead
4. While you still need to [install Rust][8] and [Python 3][41], you can ignore
   the other dependencies.
5. Activate the virtual environment with `venv\Scripts\Activate.bat` (in `cmd`) or
   `venv\Scripts\Activate.ps1` (in PowerShell) instead.
6. You can run all the tests with `test\run-tests.bat` instead of
   `test/run-tests.sh`.

Troubleshooting
---------------

If your compilation process keeps getting sniped by the OOM killer, as seen
below:

    c++: fatal error: Killed signal terminated program cc1plus
      compilation terminated.

Then a potential fix is to add the following code near the top of your
`CMakeLists.txt` both in `/` and  `/tpls/tweedledum`:

    set_property(GLOBAL APPEND PROPERTY JOB_POOLS link_job_pool=1)
    set(CMAKE_JOB_POOL_LINK link_job_pool)
    set_property(GLOBAL APPEND PROPERTY JOB_POOLS compile_job_pool=1)
    set(CMAKE_JOB_POOL_COMPILE compile_job_pool)

This tells CMake to tell Ninja to limit the number of linking and compilation
jobs done in parallel to just 1 each, although this can be changed by changing
the above parameters.

[8]: https://www.rust-lang.org/tools/install
[9]: https://packages.ubuntu.com/search?keywords=python3-dev
[10]: https://github.com/qir-alliance/qir-runner/
[24]: https://unix.stackexchange.com/q/129143/62375
[25]: https://en.wikipedia.org/wiki/LLVM
[26]: https://mlir.llvm.org/
[28]: https://sourceware.org/libffi/
[33]: https://github.com/facebook/zstd
[34]: https://packages.ubuntu.com/focal/amd64/libtinfo-dev
[39]: https://github.com/GNOME/libxml2
[41]: https://www.python.org/downloads/windows/
[45]: https://packages.ubuntu.com/search?keywords=python3-venv
[48]: https://github.com/scikit-build/scikit-build-core
[49]: https://github.com/ORNL-QCI/qiree
